name: Release Addon

on:
  push:
    tags:
      - 'addon-v*'  # 触发条件：推送 addon-v 开头的 tag

jobs:
  release:
    name: Release WoW Addon
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/addon-v}" >> $GITHUB_OUTPUT

      - name: Update TOC version
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          sed -i "s/## Version:.*/## Version: $VERSION/" addon/RPBox_Addon/RPBox_Addon.toc

      - name: Package addon
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          mkdir -p releases/addon/$VERSION
          cd addon && zip -r ../releases/addon/$VERSION/RPBox_Addon_$VERSION.zip RPBox_Addon

      - name: Verify packaged version
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          TOC_LINE=$(unzip -p releases/addon/$VERSION/RPBox_Addon_$VERSION.zip RPBox_Addon/RPBox_Addon.toc | tr -d '\r' | grep -E '^## Version:' | head -n1)
          echo "Packaged TOC: $TOC_LINE"
          if [ "$TOC_LINE" != "## Version: $VERSION" ]; then
            echo "Addon version mismatch: expected $VERSION"
            exit 1
          fi

      - name: Prepare addon changelog
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          NOTES_FILE="addon/release-notes/${VERSION}.txt"
          if [ -f "$NOTES_FILE" ]; then
            CHANGELOG=$(cat "$NOTES_FILE")
          else
            CHANGELOG=""
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update addon manifest
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          CHANGELOG: ${{ steps.changelog.outputs.CHANGELOG }}
        run: |
          python3 - <<'PY'
          import datetime
          import json
          import os

          manifest_path = "server/storage/addons/RPBox_Addon/manifest.json"
          version = os.environ["VERSION"].strip()
          changelog = os.environ.get("CHANGELOG", "").strip()
          release_date = datetime.date.today().isoformat()

          manifest = {"name": "RPBox_Addon", "latest": version, "versions": []}
          if os.path.exists(manifest_path):
            with open(manifest_path, "r", encoding="utf-8") as f:
              manifest = json.load(f)

          existing_entry = None
          versions = []
          for entry in manifest.get("versions", []):
            if entry.get("version") == version:
              existing_entry = entry
              continue
            versions.append(entry)

          if not changelog:
            if existing_entry and existing_entry.get("changelog"):
              changelog = existing_entry["changelog"]
            else:
              changelog = f"Release {version}"
          changelog = " ".join(changelog.splitlines()).strip()
          if existing_entry and existing_entry.get("releaseDate"):
            release_date = existing_entry["releaseDate"]
          versions.insert(0, {
            "version": version,
            "releaseDate": release_date,
            "minClientVersion": "1.0.0",
            "changelog": changelog,
            "downloadUrl": f"/api/v1/addon/download/{version}",
          })

          manifest["latest"] = version
          manifest["versions"] = versions
          with open(manifest_path, "w", encoding="utf-8") as f:
            json.dump(manifest, f, ensure_ascii=False, indent=2)
            f.write("\n")
          PY

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: ssh-keyscan -H -p 2233 ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy addon
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          REMOTE_PATH="${{ secrets.ADDON_PATH }}"

          # 上传版本包到 versions
          ssh -p 2233 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p $REMOTE_PATH/versions"
          scp -P 2233 releases/addon/$VERSION/RPBox_Addon_$VERSION.zip ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$REMOTE_PATH/versions/$VERSION.zip

          # 更新 latest
          ssh -p 2233 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "cp $REMOTE_PATH/versions/$VERSION.zip $REMOTE_PATH/latest.zip"

          # 更新 manifest.json
          scp -P 2233 server/storage/addons/RPBox_Addon/manifest.json ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$REMOTE_PATH/manifest.json

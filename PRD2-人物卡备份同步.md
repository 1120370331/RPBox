# PRD2: 人物卡跨设备备份同步

## 1. 概述

### 1.1 背景
TotalRP3 插件的人物卡数据存储在魔兽世界客户端的 `WTF/Account/{账号}/SavedVariables/` 目录下，主要涉及以下文件：

| 文件名 | 说明 | 包含数据 |
|--------|------|----------|
| `totalRP3.lua` | 人物卡配置 | TRP3_Profiles（所有人物卡） |
| `totalRP3_Data.lua` | 角色绑定数据 | TRP3_Register（角色-Profile映射、伙伴、黑名单） |
| `totalRP3_Extended.lua` | Extended插件数据 | 扩展功能配置 |
| `totalRP3_Extended_Tools.lua` | 道具数据库 | 自定义道具、物品 |
| `totalRP3_Extended_ImpExport.lua` | 导入导出缓存 | 临时导入导出数据 |

现有的魔兽插件管理软件（如 CurseForge、WowUp）主要聚焦于 `Interface/AddOns` 目录的管理，无法有效备份 WTF 目录下的角色数据。

### 1.2 目录结构

**参考数据源位置：**
```
C:\Program Files (x86)\World of Warcraft\_retail_\WTF\Account\
```

**目录层级：**
```
WTF/Account/
├── {账号ID1}/                         # 如：563986541#1
│   ├── SavedVariables/                # 账号级别数据（TRP3数据在此）
│   │   ├── totalRP3.lua
│   │   ├── totalRP3_Data.lua
│   │   └── ...
│   └── {服务器名}/                     # 如：金色平原
│       ├── {角色名1}/
│       └── {角色名2}/
├── {账号ID2}/                         # 如：331#1
│   ├── SavedVariables/
│   └── {服务器名}/
├── {账号ID3}/                         # 可能有更多账号
└── SavedVariables/                    # 全局SavedVariables（非TRP3）
```

**重要说明**：
- 一个WoW安装目录可能包含**多个战网账号**
- TRP3数据存储在**账号级别**的SavedVariables目录
- 需要扫描所有账号目录以获取完整数据

### 1.3 目标
提供一套完整的人物卡云端备份、同步、管理方案，让玩家可以：
- 一键备份本地人物卡到云端
- 跨设备同步人物卡数据
- 在云端查看和管理人物卡
- 支持版本历史和回滚

## 2. 用户故事

| 编号 | 角色 | 故事 | 优先级 |
|------|------|------|--------|
| US-01 | RP玩家 | 我想一键备份我的人物卡，以防数据丢失 | P0 |
| US-02 | RP玩家 | 我想在新电脑上快速恢复我的人物卡 | P0 |
| US-03 | RP玩家 | 我想在网页上查看我的人物卡内容 | P1 |
| US-04 | RP玩家 | 我想回滚到之前的人物卡版本 | P2 |

## 3. 功能需求

### 3.1 本地数据扫描 (P0)
- 自动检测魔兽世界安装目录
- 扫描 WTF 目录下所有账号和角色
- 解析 TRP3 Lua 数据文件
- 提取人物卡核心信息（名称、种族、职业、描述、头像等）

### 3.2 云端同步 (P0)
- 上传人物卡数据到云端
- 支持增量同步（仅同步变更部分）
- 冲突检测和解决策略
- 同步状态实时显示

### 3.3 数据恢复 (P0)
- 从云端下载人物卡数据
- 写入本地 WTF 目录
- 支持选择性恢复（单个角色/全部）

### 3.4 版本管理 (P1)
- 保留历史版本（最近 10 个版本）
- 版本对比功能
- 一键回滚到指定版本

### 3.5 云端预览 (P1)
- 网页端查看人物卡详情
- 人物卡卡片式展示
- 支持搜索和筛选

## 4. 技术方案

### 4.1 TRP3 字段对照表

**characteristics（角色特征）字段：**

| 缩写 | 全称 | 说明 |
|------|------|------|
| v | version | 数据版本号 |
| FN | FirstName | 名字 |
| LN | LastName | 姓氏 |
| TI | Title | 头衔（如"经销商"） |
| FT | FullTitle | 全名/英文名 |
| RA | Race | 种族 |
| CL | Class | 职业（RP职业，非游戏职业） |
| AG | Age | 年龄 |
| EC | EyeColor | 眼睛颜色 |
| HE | Height | 身高 |
| WE | Weight | 体重 |
| BP | Birthplace | 出生地 |
| RE | Residence | 居住地 |
| IC | Icon | 头像图标 |
| MI | MiscInfo | 其他信息（数组） |
| PS | PersonalityStats | 性格属性（数组） |
| RS | RelationshipStatus | 感情状态 |
| EH | EyeColorHex | 眼睛颜色（十六进制） |
| CH | ClassColorHex | 职业颜色（十六进制） |

**about（关于）字段：**

| 缩写 | 全称 | 说明 |
|------|------|------|
| TE | Template | 模板类型（1=模板1, 2=模板2, 3=模板3） |
| T1 | Template1 | 模板1内容 |
| T2 | Template2 | 模板2内容 |
| T3 | Template3 | 模板3内容（PH=外貌, PS=性格, HI=历史） |

**character（角色状态）字段：**

| 缩写 | 全称 | 说明 |
|------|------|------|
| RP | RoleplayStatus | RP状态（1=IC, 2=OOC） |
| WU | WalkUp | 是否接受搭话 |
| CU | Currently | 当前状态文本 |
| CO | CurrentlyOOC | OOC状态文本 |

### 4.2 数据结构

**TRP3原始数据结构（Lua）：**
```lua
TRP3_Profiles = {
  ["profileId"] = {
    ["profileName"] = "角色名",
    ["player"] = {
      ["characteristics"] = { FN, LN, TI, RA, CL, ... },
      ["about"] = { TE, T1, T2, T3 },
      ["character"] = { RP, WU, CU, CO },
      ["misc"] = { PE, ST }
    },
    ["inventory"] = { ... },  -- Extended
    ["questlog"] = { ... },   -- Extended
    ["auras"] = { ... }       -- Extended
  }
}

TRP3_Register = {
  ["character"] = {
    ["角色名-服务器"] = { profileID, class, race, ... }
  },
  ["companion"] = { ... },
  ["blockList"] = { ... }
}
```

**RPBox数据库模型（TypeScript）：**
```typescript
// WoW账号（本地）
interface WowAccount {
  accountId: string;             // 如：563986541#1
  wowPath: string;               // WoW安装路径
  profileCount: number;          // 人物卡数量
  lastScanned: Date;
}

// 人物卡配置
interface Profile {
  id: string;                    // TRP3 profileId
  userId: number;                // RPBox用户ID
  wowAccountId: string;          // WoW账号ID（如：563986541#1）
  profileName: string;           // 配置名称
  characteristics: {
    firstName?: string;          // FN
    lastName?: string;           // LN
    title?: string;              // TI
    fullTitle?: string;          // FT
    race?: string;               // RA
    class?: string;              // CL
    age?: string;                // AG
    eyeColor?: string;           // EC
    height?: string;             // HE
    weight?: string;             // WE
    birthplace?: string;         // BP
    residence?: string;          // RE
    icon?: string;               // IC
  };
  about: {
    template: number;            // TE
    physical?: string;           // T3.PH
    personality?: string;        // T3.PS
    history?: string;            // T3.HI
  };
  rawLua: string;                // 原始Lua数据（用于完整恢复）
  checksum: string;              // 数据校验和
  version: number;               // 版本号
  syncedAt: Date;
  createdAt: Date;
  updatedAt: Date;
}

// 角色绑定
interface CharacterBinding {
  id: number;
  userId: number;
  characterName: string;         // 角色名
  realmName: string;             // 服务器名
  profileId: string;             // 绑定的Profile ID
  gameClass: string;             // 游戏职业
  gameRace: string;              // 游戏种族
  faction: string;               // 阵营
}
```

### 4.3 Lua 解析器

**技术选型：**
- 客户端（Tauri/Rust）：使用 `mlua` 或 `rlua` crate 解析Lua
- 备选方案：使用纯文本解析器（正则 + 状态机）

**解析流程：**
```
1. 读取 .lua 文件
2. 提取全局变量赋值（TRP3_Profiles = {...}）
3. 解析 Lua table 为 JSON
4. 映射字段缩写为完整名称
5. 验证数据完整性
```

**注意事项：**
- SavedVariables 文件使用 UTF-8 编码
- 需处理中文角色名和服务器名
- 保留原始 rawLua 用于完整恢复

### 4.4 文件监控
使用文件系统监控（Tauri fs watch）检测 WTF 目录变更，提示用户同步。

### 4.5 WoW路径自动检测

**检测优先级：**
1. 读取用户上次保存的路径
2. 检测常见安装位置
3. 读取注册表/启动器配置
4. 手动选择

**Windows常见路径：**
```
C:\Program Files (x86)\World of Warcraft\
C:\Program Files\World of Warcraft\
D:\World of Warcraft\
D:\Games\World of Warcraft\
E:\World of Warcraft\
```

**检测逻辑：**
```
遍历候选路径
    │
    ▼
检查 _retail_\WTF\Account 是否存在
    │
    ├─ 存在 → 加入有效路径列表
    │
    └─ 不存在 → 跳过

返回所有有效路径供用户选择
```

**注册表检测（备选）：**
```
HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Blizzard Entertainment\World of Warcraft
```

### 4.6 同步触发时机

| 触发方式 | 说明 | 优先级 |
|----------|------|--------|
| 手动触发 | 用户点击"同步"按钮 | P0 |
| 启动检查 | 应用启动时自动扫描本地变更 | P0 |
| 文件监控 | 检测到 totalRP3.lua 变更时提示 | P1 |
| 定时检查 | 可配置的定时扫描（默认关闭） | P2 |

**文件监控细节：**
- 监控路径：`WTF/Account/*/SavedVariables/totalRP3*.lua`
- 触发条件：文件修改时间变化
- 防抖处理：文件变更后等待 5 秒再触发（避免游戏写入过程中触发）
- 游戏运行检测：检测到 WoW 进程运行时，暂停监控（游戏退出后再扫描）

### 4.7 同步策略

**变更检测：**
```
本地文件 checksum (MD5) ←→ 云端存储 checksum
    │                           │
    └─────── 不一致 ─────────────┘
                │
                ▼
          [需要同步]
```

**同步方向判断：**
| 本地状态 | 云端状态 | 动作 |
|----------|----------|------|
| 有变更 | 无变更 | 上传本地 → 云端 |
| 无变更 | 有变更 | 下载云端 → 本地（需确认） |
| 有变更 | 有变更 | 冲突，需用户选择 |
| 无变更 | 无变更 | 跳过 |

### 4.8 冲突处理

**冲突场景：** 本地和云端都有修改（如在两台电脑上分别编辑）

**解决策略：**
1. **时间优先**（默认）：保留最后修改的版本
2. **本地优先**：始终以本地为准
3. **云端优先**：始终以云端为准
4. **手动选择**：弹窗让用户对比选择

**冲突提示界面：**
```
┌─────────────────────────────────────────┐
│  ⚠️ 检测到冲突：芙拉莉雅                  │
├─────────────────────────────────────────┤
│  本地版本: 2024-01-11 20:00             │
│  云端版本: 2024-01-11 18:30             │
├─────────────────────────────────────────┤
│  [使用本地]  [使用云端]  [查看差异]      │
└─────────────────────────────────────────┘
```

### 4.9 API 接口设计

**人物卡相关接口：**

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/profiles | 获取用户所有人物卡列表 |
| GET | /api/v1/profiles/:id | 获取单个人物卡详情 |
| POST | /api/v1/profiles | 上传/创建人物卡 |
| PUT | /api/v1/profiles/:id | 更新人物卡 |
| DELETE | /api/v1/profiles/:id | 删除人物卡 |
| GET | /api/v1/profiles/:id/versions | 获取版本历史 |
| POST | /api/v1/profiles/:id/rollback | 回滚到指定版本 |

### 4.10 同步流程

#### 4.10.1 写回本地机制

**核心原则：** 保留原始Lua格式，确保游戏能正确读取

**写入时机：**
```
检测WoW进程是否运行
    │
    ├─ 运行中 → 提示用户关闭游戏后再操作
    │
    └─ 未运行 → 允许写入
```

**写入流程：**
```
1. 备份原文件 → totalRP3.lua.rpbox_backup
2. 读取原文件完整内容
3. 定位目标Profile在Lua中的位置
4. 替换/插入Profile数据
5. 写入新文件
6. 验证文件语法正确性
7. 删除备份（或保留供回滚）
```

**Lua格式保持：**
```lua
-- 必须保持TRP3原始格式
TRP3_Profiles = {
    ["profileId"] = {
        ["profileName"] = "芙拉莉雅",
        ["player"] = {
            -- 保持原始缩写字段名（FN, LN, RA等）
            ["characteristics"] = {
                ["FN"] = "芙拉莉雅",
                ["RA"] = "人类",
                ...
            },
        },
    },
}
```

#### 4.10.2 云端迁移生效

**迁移场景：** 新电脑/重装系统后恢复人物卡

**账号ID说明：**
- 文件夹名格式：`<Battle.net账号ID>#<WoW许可证索引>`
- 例如 `563986541#1` 中，`563986541` 是Battle.net账号ID
- **此ID绑定账号而非设备，换电脑不会改变**
- 新电脑首次登录WoW会自动创建同名文件夹

**账号友好标识：**

从目录结构可提取用户友好信息：
```
WTF/Account/{账号ID}/
├── {服务器名}/           ← 可读取服务器名
│   ├── {角色名1}/       ← 可读取角色名列表
│   ├── {角色名2}/
│   └── ...
```

**显示效果：**
```
┌─────────────────────────────────────────┐
│  选择要恢复的账号：                      │
├─────────────────────────────────────────┤
│  ○ 563986541#1                          │
│    └─ 金色平原 (25个角色)                │
│       芙拉莉雅, 卡洛斯丶海顿, 塔莉恩...  │
│                                         │
│  ○ 331#1                                │
│    └─ 暴风城 (3个角色)                   │
│       角色A, 角色B...                    │
└─────────────────────────────────────────┘
```

**恢复前置条件检测：**

| 场景 | WTF/Account目录 | SavedVariables目录 | totalRP3.lua | 处理方式 |
|------|----------------|-------------------|--------------|----------|
| A | 不存在 | - | - | 提示：请先登录一次WoW |
| B | 存在 | 不存在 | - | 提示：请先进入一次游戏角色 |
| C | 存在 | 存在 | 不存在 | 提示：请先安装TRP3并进入游戏一次 |
| D | 存在 | 存在 | 存在(空/默认) | 可直接写入恢复数据 |
| E | 存在 | 存在 | 存在(有数据) | 提示是否覆盖/合并 |

**迁移流程：**
```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 登录RPBox│───▶│ 拉取云端│───▶│ 选择要  │───▶│ 写入本地│
│ 账号    │    │ 人物卡  │    │ 恢复的卡│    │ WTF目录 │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

**关键保障：**
1. **rawLua字段**：云端存储原始Lua文本，恢复时直接写回
2. **角色绑定**：同时恢复TRP3_Register中的角色-Profile映射
3. **目录创建**：如果目标账号目录不存在，自动创建

**上传流程：**
```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 扫描本地 │───▶│ 解析Lua │───▶│ 计算校验│───▶│ 对比云端│
│ WTF目录 │    │ 数据文件│    │ 和(MD5) │    │ 版本   │
└─────────┘    └─────────┘    └─────────┘    └────┬────┘
                                                  │
                              ┌───────────────────┴───────────────────┐
                              ▼                                       ▼
                        [有变更]                                [无变更]
                              │                                       │
                              ▼                                       ▼
                        ┌─────────┐                             ┌─────────┐
                        │ 上传到  │                             │ 跳过    │
                        │ 云端    │                             │         │
                        └─────────┘                             └─────────┘
```

**下载/恢复流程：**
```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 选择要  │───▶│ 下载云端│───▶│ 备份本地│───▶│ 写入Lua│
│ 恢复的卡│    │ 数据    │    │ 原文件  │    │ 文件   │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 4.11 错误处理

**常见错误类型：**

| 错误类型 | 原因 | 处理方式 |
|----------|------|----------|
| 文件读取失败 | 权限不足/文件被占用 | 提示关闭游戏后重试 |
| Lua解析失败 | 文件损坏/格式异常 | 跳过并记录日志 |
| 网络超时 | 网络不稳定 | 自动重试3次 |
| 云端冲突 | 并发修改 | 进入冲突处理流程 |
| 磁盘空间不足 | 本地空间不够 | 提示清理空间 |

### 4.12 重试机制

```
请求失败
    │
    ▼
[重试次数 < 3?]──否──▶ 标记失败，提示用户
    │
   是
    │
    ▼
等待 (2^n) 秒  ← 指数退避
    │
    ▼
  重新请求
```

### 4.14 性能考虑

**大量人物卡处理：**
- 分页加载：每页显示 20 个人物卡
- 虚拟滚动：超过 50 个时启用
- 懒加载：详情数据按需加载

**同步优化：**
- 增量同步：仅同步变更的人物卡
- 并发控制：最多同时上传 3 个
- 压缩传输：gzip 压缩请求体

### 4.15 日志记录

**同步日志：**
- 记录每次同步的时间、结果、变更数量
- 本地存储最近 100 条记录
- 支持导出日志文件

**日志格式：**
```
[2024-01-11 20:00:15] [INFO] 开始同步，检测到 3 个变更
[2024-01-11 20:00:16] [INFO] 上传: 芙拉莉雅 (v3)
[2024-01-11 20:00:17] [INFO] 上传: 塔莉恩 (v2)
[2024-01-11 20:00:18] [ERROR] 上传失败: 克拉丽丝 - 网络超时
[2024-01-11 20:00:20] [INFO] 同步完成，成功 2，失败 1
```

### 4.16 数据安全

**传输安全：**
- 所有API请求使用 HTTPS
- JWT Token 认证，有效期 7 天
- 敏感操作需二次确认

**存储安全：**
- 云端数据按用户隔离
- 数据库字段级加密（可选）
- 定期备份（每日）

### 4.18 批量操作

**支持的批量操作：**
| 操作 | 说明 |
|------|------|
| 批量同步 | 选中多个人物卡一键同步 |
| 批量删除 | 删除云端多个人物卡 |
| 全选/反选 | 快速选择操作 |

**主界面批量模式：**
```
┌─────────────────────────────────────────────┐
│  人物卡管理          [批量模式] [同步全部]   │
├─────────────────────────────────────────────┤
│  ☑ 全选                                     │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │☑ 芙拉莉雅│ │☑ 塔莉恩  │ │☐ 克拉丽丝│       │
│  └─────────┘ └─────────┘ └─────────┘       │
├─────────────────────────────────────────────┤
│  已选择 2 个    [同步选中] [删除选中]        │
└─────────────────────────────────────────────┘
```

### 4.19 AI辅助功能 (P2)

**功能列表：**
| 功能 | 说明 | 优先级 |
|------|------|--------|
| 描述润色 | AI优化人物卡描述文本 | P2 |
| 内容翻译 | 中英文互译 | P2 |
| 智能补全 | 根据已有信息补全空白字段 | P3 |

**调用方式：**
- 在人物卡详情页提供"AI助手"按钮
- 用户选择需要处理的字段
- 调用后端AI服务处理

## 5. 界面原型

### 5.1 首次使用引导

**步骤1：选择WoW安装目录**
```
┌─────────────────────────────────────────┐
│  欢迎使用 RPBox 人物卡同步              │
├─────────────────────────────────────────┤
│  🔍 正在自动检测魔兽世界安装目录...      │
│                                         │
│  ✓ 已找到以下安装位置：                  │
│  ○ C:\Program Files (x86)\World of...  │
│  ○ D:\Games\World of Warcraft\         │
│                                         │
│  [手动选择其他目录...]                   │
├─────────────────────────────────────────┤
│                            [下一步 →]   │
└─────────────────────────────────────────┘
```

**步骤2：扫描人物卡**
```
┌─────────────────────────────────────────┐
│  正在扫描人物卡...                       │
├─────────────────────────────────────────┤
│  账号 563986541#1:                       │
│    ✓ 芙拉莉雅、塔莉恩、克拉丽丝...       │
│    共发现 12 个人物卡                    │
│                                         │
│  账号 331#1:                            │
│    ✓ 共发现 3 个人物卡                   │
├─────────────────────────────────────────┤
│  总计: 15 个人物卡待备份                 │
│                       [开始备份 →]       │
└─────────────────────────────────────────┘
```

### 5.2 主界面
```
┌─────────────────────────────────────────────┐
│  人物卡管理                      [同步全部]  │
├─────────────────────────────────────────────┤
│  WoW路径: C:\Program Files (x86)\World...   │
│  账号选择: [563986541#1 ▼]  (共4个账号)      │
├─────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │ 芙拉莉雅 │ │ 塔莉恩   │ │ 克拉丽丝 │       │
│  │ ✓ 已同步 │ │ ⟳ 待同步 │ │ ✓ 已同步 │       │
│  └─────────┘ └─────────┘ └─────────┘       │
├─────────────────────────────────────────────┤
│  最后同步: 2024-01-11 20:00                 │
└─────────────────────────────────────────────┘
```

### 5.3 人物卡详情页
```
┌─────────────────────────────────────────────┐
│  ← 返回                    [同步] [历史版本] │
├─────────────────────────────────────────────┤
│  ┌──────┐  芙拉莉雅                         │
│  │ 头像 │  人类 · 潜行者                     │
│  │      │  "影子中的低语者"                  │
│  └──────┘                                   │
├─────────────────────────────────────────────┤
│  基本信息                                    │
│  ├─ 名字: 芙拉莉雅                          │
│  ├─ 头衔: 影子中的低语者                     │
│  ├─ 种族: 人类                              │
│  ├─ 职业: 潜行者                            │
│  ├─ 年龄: 26                                │
│  └─ 居住地: 暴风城                          │
├─────────────────────────────────────────────┤
│  外貌描述                                    │
│  一头乌黑的长发...                           │
├─────────────────────────────────────────────┤
│  性格特点                                    │
│  沉默寡言，但内心善良...                      │
├─────────────────────────────────────────────┤
│  历史背景                                    │
│  出生于西部荒野的一个小村庄...                │
├─────────────────────────────────────────────┤
│  同步状态: ✓ 已同步  |  版本: v3            │
│  最后修改: 2024-01-11 20:00                 │
└─────────────────────────────────────────────┘
```

### 5.4 版本历史页
```
┌─────────────────────────────────────────────┐
│  ← 返回详情          芙拉莉雅 - 版本历史     │
├─────────────────────────────────────────────┤
│  ┌─────────────────────────────────────┐   │
│  │ v3 (当前)     2024-01-11 20:00      │   │
│  │ 修改了外貌描述                       │   │
│  │                      [查看] [恢复]  │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ v2            2024-01-10 15:30      │   │
│  │ 更新了历史背景                       │   │
│  │                      [查看] [恢复]  │   │
│  └─────────────────────────────────────┘   │
│  ┌─────────────────────────────────────┐   │
│  │ v1            2024-01-08 10:00      │   │
│  │ 首次备份                            │   │
│  │                      [查看] [恢复]  │   │
│  └─────────────────────────────────────┘   │
├─────────────────────────────────────────────┤
│  共 3 个版本  |  保留最近 10 个版本         │
└─────────────────────────────────────────────┘
```

## 6. 里程碑

| 阶段 | 功能 | 状态 |
|------|------|------|
| M1 | Lua解析器 + 本地扫描 | 待开发 |
| M2 | 云端上传/下载 | 待开发 |
| M3 | 版本管理 | 待开发 |
| M4 | 云端预览 | 待开发 |

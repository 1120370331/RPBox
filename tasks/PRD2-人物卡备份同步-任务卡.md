# PRD2 人物卡备份同步 - 开发任务卡

## 概览

| 里程碑 | 任务数 | 预计复杂度 |
|--------|--------|------------|
| M1: Lua解析器 + 本地扫描 | 5 | 中 |
| M2: 云端上传/下载 | 6 | 高 |
| M3: 版本管理 | 3 | 中 |
| M4: 云端预览与编辑 | 4 | 中 |

---

## M1: Lua解析器 + 本地扫描

### T1.1 实现Lua解析器核心

**描述**: 解析TRP3 SavedVariables Lua文件，提取数据结构

**技术要点**:
- 使用Rust `mlua` crate 或纯文本解析
- 处理UTF-8编码（中文角色名）
- 解析嵌套Lua table结构

**输入**: `totalRP3.lua` 文件路径
**输出**: JSON格式的Profile数据

**验收标准**:
- [ ] 能解析标准TRP3_Profiles结构
- [ ] 能解析TRP3_Register结构
- [ ] 正确处理中文内容
- [ ] 处理特殊字符转义

**相关文件**: `client/src-tauri/src/lua_parser.rs`

---

### T1.2 实现WoW路径自动检测

**描述**: 自动检测魔兽世界安装目录

**技术要点**:
- 扫描常见安装路径
- 读取Windows注册表（备选）
- 验证目录有效性

**验收标准**:
- [ ] 能检测常见安装位置
- [ ] 能识别_retail_和_classic_目录
- [ ] 支持手动选择目录
- [ ] 记住用户选择

**相关文件**: `client/src-tauri/src/wow_detector.rs`

---

### T1.3 实现本地文件扫描

**描述**: 扫描WTF目录下所有账号和Profile

**技术要点**:
- 遍历Account目录结构
- 识别多账号
- 提取角色-服务器信息

**验收标准**:
- [ ] 能扫描多个WoW账号
- [ ] 能列出所有Profile
- [ ] 能提取角色绑定信息
- [ ] 扫描100个Profile < 5秒

**相关文件**: `client/src-tauri/src/scanner.rs`

---

### T1.4 实现字段映射

**描述**: 将Lua缩写字段映射为完整字段名

**技术要点**:
- 映射characteristics字段（FN→firstName等）
- 映射about模板结构
- 映射PS性格特征预设

**验收标准**:
- [ ] 完整映射所有TRP3字段
- [ ] 支持Extended字段映射
- [ ] 处理缺失字段默认值

**相关文件**: `client/src/utils/fieldMapper.ts`

---

### T1.5 实现首次使用引导UI

**描述**: 实现首次使用的引导流程界面

**技术要点**:
- 步骤式引导组件
- 路径选择器
- 扫描进度显示

**验收标准**:
- [ ] 完成3步引导流程
- [ ] 显示扫描结果
- [ ] 异常状态提示

**相关文件**: `client/src/views/Setup/`

---

## M2: 云端上传/下载

### T2.1 设计Profile数据库模型

**描述**: 设计并实现Profile相关数据库表

**技术要点**:
- PostgreSQL表设计
- GORM模型定义
- 索引优化

**数据表**:
- profiles (人物卡主表)
- profile_versions (版本历史)
- sync_logs (同步日志)

**验收标准**:
- [ ] 完成表结构设计
- [ ] 实现GORM模型
- [ ] 编写迁移脚本

**相关文件**: `server/internal/model/profile.go`

---

### T2.2 实现Profile API

**描述**: 实现人物卡CRUD接口

**接口列表**:
- GET /api/v1/profiles
- GET /api/v1/profiles/:id
- POST /api/v1/profiles
- PUT /api/v1/profiles/:id
- DELETE /api/v1/profiles/:id

**验收标准**:
- [ ] 完成所有CRUD接口
- [ ] 实现分页和筛选
- [ ] 实现权限验证
- [ ] 编写API测试

**相关文件**: `server/internal/api/profile.go`

---

### T2.3 实现同步元数据管理

**描述**: 管理本地同步状态元数据

**技术要点**:
- 本地SQLite存储
- checksum计算
- lastSyncedAt记录

**验收标准**:
- [ ] 实现SyncMetadata存储
- [ ] 实现checksum计算（MD5）
- [ ] 实现变更检测

**相关文件**: `client/src-tauri/src/sync_metadata.rs`

---

### T2.4 实现上传流程

**描述**: 实现本地→云端上传流程

**技术要点**:
- 变更检测
- 增量上传
- 进度回调

**验收标准**:
- [ ] 实现单个Profile上传
- [ ] 实现批量上传
- [ ] 显示上传进度
- [ ] 处理上传失败重试

**相关文件**: `client/src/services/syncService.ts`

---

### T2.5 实现下载/恢复流程

**描述**: 实现云端→本地下载和恢复

**技术要点**:
- 下载Profile数据
- 写入本地Lua文件
- 保持Lua格式

**验收标准**:
- [ ] 实现下载功能
- [ ] 实现写回本地
- [ ] 自动备份原文件
- [ ] 检测WoW运行状态

**相关文件**: `client/src-tauri/src/lua_writer.rs`

---

### T2.6 实现冲突检测和处理

**描述**: 检测并处理本地/云端冲突

**技术要点**:
- 时间戳对比
- 冲突UI展示
- 用户选择处理

**验收标准**:
- [ ] 正确检测冲突
- [ ] 显示冲突对比界面
- [ ] 支持多种解决策略

**相关文件**: `client/src/components/ConflictDialog.vue`

---

## M3: 版本管理

### T3.1 实现版本历史存储

**描述**: 存储Profile的历史版本

**技术要点**:
- 版本快照存储
- 变更摘要生成
- 版本数量限制（10个）

**验收标准**:
- [ ] 每次保存创建新版本
- [ ] 自动生成变更摘要
- [ ] 超过10个自动清理

**相关文件**: `server/internal/service/version.go`

---

### T3.2 实现版本历史API和UI

**描述**: 版本历史查询和展示

**接口**: GET /api/v1/profiles/:id/versions

**验收标准**:
- [ ] 实现版本列表API
- [ ] 实现版本历史页面
- [ ] 显示变更摘要

**相关文件**: `client/src/views/Profile/VersionHistory.vue`

---

### T3.3 实现版本回滚

**描述**: 回滚到指定历史版本

**接口**: POST /api/v1/profiles/:id/rollback

**验收标准**:
- [ ] 实现回滚API
- [ ] 回滚确认对话框
- [ ] 回滚后同步到本地

**相关文件**: `server/internal/api/version.go`

---

## M4: 云端预览与编辑

### T4.1 实现主界面

**描述**: 人物卡列表主界面

**功能**:
- 卡片式展示
- 状态标识
- 账号切换
- 批量操作

**验收标准**:
- [ ] 完成卡片组件
- [ ] 实现状态显示
- [ ] 实现右键菜单
- [ ] 实现批量选择

**相关文件**: `client/src/views/Home/`

---

### T4.2 实现人物卡详情页

**描述**: 人物卡详细信息展示

**功能**:
- 标签页切换
- 字段展示
- 同步状态

**验收标准**:
- [ ] 完成详情页布局
- [ ] 实现标签页切换
- [ ] 显示所有TRP3字段

**相关文件**: `client/src/views/Profile/Detail.vue`

---

### T4.3 实现人物卡编辑

**描述**: 在RPBox内编辑人物卡

**功能**:
- 字段编辑表单
- 富文本编辑
- 实时预览

**验收标准**:
- [ ] 完成编辑表单
- [ ] 支持TRP3颜色代码
- [ ] 实现草稿保存

**相关文件**: `client/src/views/Profile/Edit.vue`

---

### T4.4 实现设置页面

**描述**: 应用设置界面

**功能**:
- 账号管理
- 路径设置
- 同步设置

**验收标准**:
- [ ] 完成设置页面
- [ ] 实现配置持久化

**相关文件**: `client/src/views/Settings/`

---

## 开发顺序建议

```
Phase 1 (基础能力):
T1.1 → T1.2 → T1.3 → T1.4 → T1.5

Phase 2 (后端API):
T2.1 → T2.2

Phase 3 (同步核心):
T2.3 → T2.4 → T2.5 → T2.6

Phase 4 (版本管理):
T3.1 → T3.2 → T3.3

Phase 5 (界面完善):
T4.1 → T4.2 → T4.3 → T4.4
```

## 技术依赖

| 任务 | 前置依赖 |
|------|----------|
| T1.3 | T1.1, T1.2 |
| T1.4 | T1.1 |
| T1.5 | T1.2, T1.3 |
| T2.2 | T2.1 |
| T2.3 | T1.1 |
| T2.4 | T2.2, T2.3 |
| T2.5 | T2.2, T1.1 |
| T2.6 | T2.3, T2.4 |
| T3.1 | T2.1 |
| T3.2 | T3.1 |
| T3.3 | T3.1 |
| T4.1 | T1.3, T2.4 |
| T4.2 | T1.4 |
| T4.3 | T4.2, T2.5 |
